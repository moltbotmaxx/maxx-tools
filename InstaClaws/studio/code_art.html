<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>MAXX_STUDIO_v5_CODE_ART</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            background: #000;
            color: #fff;
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-family: 'Space Grotesk', sans-serif;
        }

        aside {
            width: 320px;
            background: #050505;
            border-right: 1px solid #111;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .label {
            font-size: 10px;
            color: red;
            font-weight: 800;
            letter-spacing: 2px;
        }

        input {
            background: #000;
            border: 1px solid #111;
            color: #888;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            outline: none;
        }

        button {
            background: red;
            color: #fff;
            border: none;
            padding: 15px;
            font-weight: 800;
            cursor: pointer;
            margin-top: auto;
            transition: 0.2s;
        }

        button:hover {
            background: #fff;
            color: red;
        }

        main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #020202;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>

<body>
    <aside>
        <div class="label">M_ENGINE_v5_CODE_ART</div>
        <div style="display:flex; flex-direction:column; gap:5px;">
            <label style="font-size:9px; color:#333;">SCRIPT NAME</label>
            <input type="text" id="scriptName" value="SYS_KERNEL_v4.js" oninput="updateCode()">
        </div>
        <div style="display:flex; flex-direction:column; gap:5px;">
            <label style="font-size:9px; color:#333;">LOG_ID</label>
            <input type="text" id="logId" value="RUN // 992-A" oninput="updateCode()">
        </div>
        <button onclick="saveImage()">Capture Frame</button>
    </aside>
    <main>
        <div id="canvas-container"></div>
    </main>
    <script>
        let W = 1080; let H = 1440;
        let codeLines = [
            "// M_ENGINE: Kernel Initialization",
            "// Priority: CRITICAL",
            "const SYSTEM_LIMIT = 9000;",
            "let current_load = 0;",
            "",
            "class Entity {",
            "  constructor(id, type) {",
            "    this.id = id;",
            "    this.type = type || 'UNKNOWN';",
            "    this.active = true;",
            "  }",
            "  ",
            "  scan() {",
            "    console.log(`Scanning sector...`);",
            "    return this.detect_anomalies();",
            "  }",
            "}",
            "",
            "function initiate_sequence(target) {",
            "  if (!target.active) {",
            "    return false;",
            "  }",
            "  let payload = new Package(target.id);",
            "  payload.transmit();",
            "  return true;",
            "}",
            "",
            "// Automated system check",
            "try {",
            "  let status = initiate_sequence(primary_node);",
            "  console.log(\"Sequence Status: \" + status);",
            "} catch (err) {",
            "  console.error(\"CRITICAL_FAILURE\");",
            "}",
            "",
            "// End of transmission",
            ">> SYSTEM_READY"
        ];
        let titleText = "";
        let logId = "";
        let scriptName = "";

        function setup() {
            createCanvas(W, H).parent('canvas-container');
            pixelDensity(1);
            handleResize();
            window.addEventListener('resize', handleResize);
            updateCode(); // Initialize values from inputs
            noLoop(); // Only draw when needed
        }

        function handleResize() {
            let scale = Math.min((document.querySelector('main').clientWidth - 40) / W, (document.querySelector('main').clientHeight - 40) / H);
            let c = document.querySelector('canvas');
            c.style.width = (W * scale) + 'px';
            c.style.height = (H * scale) + 'px';
        }

        function updateCode() {
            scriptName = document.getElementById('scriptName').value;
            logId = document.getElementById('logId').value;
            redraw(); // Redraw canvas when inputs change
        }

        function draw() {
            background(10); // Darker Grey/Black

            // IDE-like grid (Subtle)
            stroke(30); strokeWeight(1);
            for (let i = 0; i <= W; i += 100) line(i, 0, i, H);
            for (let i = 0; i <= H; i += 50) line(0, i, W, i);

            // DYNAMIC SIZING FOR CODE
            // Calculate optimal font size to fit ALL codeLines within (W-160) x (H-200) area
            // Area approximate height: StartY(100) to Footer(H-100) = H-200.

            let maxCodeW = W - 160;
            let maxCodeH = H - 250; // extra padding for bottom branding

            // Find longest line char count (rough approximation for monospace)
            let longestLineChars = 0;
            for (let line of codeLines) {
                if (line.length > longestLineChars) longestLineChars = line.length;
            }

            // Helper to calc dimensions for a given size
            // Monospace char width is roughly size * 0.6
            // Line height is usually size * 1.5
            let testSize = 40; // Start big
            let finalSize = 12; // Min size

            while (testSize > 12) {
                let charW = testSize * 0.6; // approx monospace width
                let totalW = longestLineChars * charW;
                let totalH = codeLines.length * (testSize * 1.5);

                if (totalW < maxCodeW && totalH < maxCodeH) {
                    finalSize = testSize;
                    break;
                }
                testSize--;
            }

            textFont('monospace');
            textSize(finalSize);
            let lineHeight = finalSize * 1.5;
            let startY = 100;
            let codePaddingX = 80;

            for (let i = 0; i < codeLines.length; i++) {
                drawHighlightedText(codeLines[i], codePaddingX, startY + i * lineHeight);
            }

            // UNIFIED FOOTER / DATA BAR
            fill(0); rect(0, H - 100, W, 100);
            stroke(255, 0, 0); strokeWeight(2); line(0, H - 100, W, H - 100);

            fill(255); noStroke(); textSize(20); textAlign(LEFT, CENTER);
            text(">> SCRIPT: " + scriptName.toUpperCase(), 40, H - 50);

            textAlign(RIGHT, CENTER); fill(150);
            text(logId.toUpperCase(), W - 40, H - 50);
        }

        function drawHighlightedText(lineCode, x, y) {
            let cursorX = x;

            // Regex to split by tokens but keep delimiters
            // Captures: strings, comments, keywords, numbers, operators/punctuation, whitespace
            let tokens = lineCode.split(/(\/\/.*$|"[^"]*"|'[^']*'|\b(?:const|let|var|function|if|else|return|class|constructor|try|catch|new|this)\b|\b\d+\b|[(){}\[\],.;])/g);

            for (let i = 0; i < tokens.length; i++) {
                let token = tokens[i];
                if (!token) continue;

                // Default color (White/Greyish for identifiers/text)
                fill(230);

                // 1. Comments (Dark Grey)
                if (token.startsWith('//')) {
                    fill(100);
                }
                // 2. Strings (Orange)
                else if (token.startsWith('"') || token.startsWith("'")) {
                    fill(255, 140, 0); // Darker Orange
                }
                // 3. Keywords (Red)
                else if (/^(const|let|var|function|if|else|return|class|constructor|try|catch|new|this)$/.test(token)) {
                    fill(255, 50, 50); // Bright Red
                }
                // 4. Numbers (Dark Red / Maroon)
                else if (/^\d+$/.test(token)) {
                    fill(200, 50, 50);
                }
                // 5. Punctuation/Operators (Darker Grey)
                else if (/^[(){}\[\],.;]$/.test(token)) {
                    fill(150);
                }

                text(token, cursorX, y);
                cursorX += textWidth(token);
            }
        }

        function saveImage() {
            let out = get(0, 0, W, H);
            out.save('CODE_ART_' + Date.now(), 'png');
        }
    </script>
</body>

</html>